// --- KONFIGURASI API & ASET ---
const API_KEY = 'd66d98aa9132431bbf630644f25f8ad5'; 

const assets = {
    'BTC': { price: 0, dec: 2, dir: null, candles: [] },
    'XAU': { price: 0, dec: 2, dir: null, candles: [] },
    'XAG': { price: 0, dec: 3, dir: null, candles: [] }
};

// RR 1:3. SL menyesuaikan Timeframe
const risk = {
    'SCALPING': { sl: { 'BTC': 30, 'XAU': 1.5, 'XAG': 0.15 } },
    'MEDIUM':   { sl: { 'BTC': 100, 'XAU': 4.0, 'XAG': 0.40 } },
    'LONGTERM': { sl: { 'BTC': 300, 'XAU': 12.0, 'XAG': 1.00 } }
};

document.addEventListener('DOMContentLoaded', async () => {
    toast('System Booting', 'SMC Limit Order Engine siap...');
    await fetchHistoryBTC();
    await fetchHistoryMetals();
    initWSBTC();
    initWSMetals();
    startScanner();
});

// --- FETCH DATA HISTORIS ---
async function fetchHistoryBTC() {
    try {
        const res = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=15m&limit=500');
        const data = await res.json();
        assets['BTC'].candles = data.map(k => ({ open: parseFloat(k[1]), high: parseFloat(k[2]), low: parseFloat(k[3]), close: parseFloat(k[4]) }));
    } catch(e) {}
}

async function fetchHistoryMetals() {
    try {
        const url = `https://api.twelvedata.com/time_series?symbol=XAU/USD,XAG/USD&interval=15min&outputsize=500&apikey=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data['XAU/USD']) assets['XAU'].candles = data['XAU/USD'].values.reverse().map(k => ({ open: parseFloat(k.open), high: parseFloat(k.high), low: parseFloat(k.low), close: parseFloat(k.close) }));
        if (data['XAG/USD']) assets['XAG'].candles = data['XAG/USD'].values.reverse().map(k => ({ open: parseFloat(k.open), high: parseFloat(k.high), low: parseFloat(k.low), close: parseFloat(k.close) }));
    } catch(e) {}
}

// --- WEBSOCKET & SPREAD ---
function initWSBTC() {
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
    ws.onmessage = (e) => updatePrice('BTC', parseFloat(JSON.parse(e.data).c));
    ws.onclose = () => setTimeout(initWSBTC, 5000);
}

function initWSMetals() {
    const ws = new WebSocket(`wss://ws.twelvedata.com/v1/quotes/price?apikey=${API_KEY}`);
    ws.onopen = () => ws.send(JSON.stringify({ action: "subscribe", params: { symbols: "XAU/USD,XAG/USD" } }));
    ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.event === 'price') updatePrice(d.symbol.split('/')[0], parseFloat(d.price));
    };
    ws.onclose = () => setTimeout(initWSMetals, 5000);
}

function updatePrice(asset, price) {
    if (!assets[asset]) return;
    assets[asset].price = price;
    
    let spread = asset === 'BTC' ? (Math.random()*0.5)+0.1 : asset === 'XAU' ? (Math.random()*0.15)+0.05 : (Math.random()*0.015)+0.005;
    
    const c = assets[asset].candles;
    if (c.length > 0) {
        c[c.length-1].close = price;
        if(price > c[c.length-1].high) c[c.length-1].high = price;
        if(price < c[c.length-1].low) c[c.length-1].low = price;
    }
    const el = document.getElementById(`${asset.toLowerCase()}-price`);
    if(el) el.innerHTML = `${price.toFixed(assets[asset].dec)} <span style="font-size:10px;color:#94a3b8">Sp:${spread.toFixed(asset==='BTC'?1:2)}</span>`;
}

// --- MTFA & SMC ENGINE ---
function buildHTF(candles, mult) {
    let htf = [];
    for (let i = 0; i <= candles.length - mult; i += mult) {
        let chunk = candles.slice(i, i + mult);
        htf.push({ open: chunk[0].open, high: Math.max(...chunk.map(c=>c.high)), low: Math.min(...chunk.map(c=>c.low)), close: chunk[chunk.length-1].close });
    }
    return htf;
}

function startScanner() {
    setInterval(() => {
        ['BTC', 'XAU', 'XAG'].forEach(asset => {
            if (assets[asset].candles.length > 100) {
                const res = analyzeMTFA(asset, assets[asset].candles);
                updateUI(asset, res);
            }
        });
    }, 60000); 
}

function analyzeMTFA(asset, c15m) {
    const c1H = buildHTF(c15m, 4);  
    const c4H = buildHTF(c15m, 16); 
    const cD1 = buildHTF(c15m, 96); 

    if (cD1.length > 3 && c4H.length > 5) {
        let t = getTrend(cD1); let s = getSetup(c4H, t);
        if (s.score === 6) return formatOut('LONGTERM', s, t);
    }
    if (c4H.length > 3 && c1H.length > 5) {
        let t = getTrend(c4H); let s = getSetup(c1H, t);
        if (s.score === 6) return formatOut('MEDIUM', s, t);
    }
    if (c1H.length > 3 && c15m.length > 5) {
        let t = getTrend(c1H); let s = getSetup(c15m, t);
        if (s.score === 6) return formatOut('SCALPING', s, t);
        return formatOut('SCANNING', s, t);
    }
    return { score: 0, text: "Wait..." };
}

function getTrend(c) {
    const start = c[c.length - Math.min(5, c.length)].close;
    const curr = c[c.length - 2].close;
    return curr > start ? 'BULL' : curr < start ? 'BEAR' : 'RANGING';
}

function getSetup(c, t) {
    if (t === 'RANGING') return { score: 0, arr: [], limitPrice: 0 };
    const curr = c[c.length - 2], ob = c[c.length - 3], gap = c[c.length - 4];
    const body = Math.abs(curr.open - curr.close);
    
    const swUp = (curr.high - Math.max(curr.open, curr.close)) > body * 1.5;
    const swDn = (Math.min(curr.open, curr.close) - curr.low) > body * 1.5;
    
    const obBull = ob.close < ob.open && curr.close > curr.open && body > Math.abs(ob.close - ob.open) * 1.5;
    const obBear = ob.close > ob.open && curr.close < curr.open && body > Math.abs(ob.close - ob.open) * 1.5;
    
    let isOB = false, isSw = false, isGap = false;
    let limitPrice = 0; // Titik Entry Pending Order

    if (t === 'BULL') { 
        isSw = swDn; isOB = obBull; isGap = curr.low - gap.high > 0; 
        // Bullish Limit diletakkan di harga tertinggi Order Block (Retest area)
        limitPrice = ob.high; 
    }
    if (t === 'BEAR') { 
        isSw = swUp; isOB = obBear; isGap = gap.low - curr.high > 0; 
        // Bearish Limit diletakkan di harga terendah Order Block (Retest area)
        limitPrice = ob.low; 
    }

    let arr = [true, true, isSw, isOB, isGap, (isOB || isGap)];
    return { score: arr.filter(x=>x).length, arr, limitPrice };
}

function formatOut(type, setup, dir) {
    if (type === 'SCANNING') return { score: setup.score, text: "üîç Menunggu Harga Membentuk Pola...\nSMC mencari manipulasi pasar sebelum entry.", type };
    
    // Alasan dan Edukasi yang akan muncul di Layar
    let txt = `${dir==='BULL'?'üü¢':'üî¥'} SETUP ${type} TERDETEKSI!\n\n` +
              `üí° KENAPA PASANG ${dir==='BULL'?'BUY':'SELL'} LIMIT DI SINI?\n` +
              `1. HTF Trend: Searah dengan tren besar (${dir}).\n` +
              `2. Inducement: Retail Stop Loss baru saja disapu habis.\n` +
              `3. Mitigation: Smart Money meninggalkan pesanan di Order Block.\n` +
              `4. FVG Magnet: Ada gap terbuka yang akan menarik harga mundur.\n\n` +
              `üéØ AKSI: Biarkan harga menjemput Limit Order Anda!`;
              
    return { score: setup.score, text: txt, type, isBull: dir === 'BULL', limitPrice: setup.limitPrice };
}

// --- UI & ALERT ---
function updateUI(asset, res) {
    const id = asset.toLowerCase();
    
    if(document.getElementById(`${id}-score`)) {
        document.getElementById(`${id}-score`).textContent = `${res.score}/6`;
        document.getElementById(`${id}-bar`).style.width = `${(res.score/6)*100}%`;
    }

    const over = document.getElementById(`${id}-overlay`);
    if(over) {
        over.style.display = 'block'; over.textContent = res.text;
        over.style.borderColor = res.score === 6 ? '#10b981' : '#334155';
        over.style.color = res.score === 6 ? '#10b981' : '#94a3b8';
    }

    const stat = document.getElementById(`${id}-status`);
    if (res.score === 6) {
        if (!assets[asset].dir) {
            stat.textContent = `LIMIT VALID (${res.type})`;
            stat.className = 'badge badge-pass';
            makeSignal(asset, res.isBull, res.type, res.limitPrice);
            alarm(); toast('üö® SMC LIMIT ALERT', `Setup Pending Order ${asset} Ditemukan!`);
        }
    } else {
        if(stat) { stat.textContent = `SCANNING (1M)`; stat.className = 'badge badge-scan'; }
        const sig = document.getElementById(`${id}-signal`);
        if(sig) sig.style.display = 'none';
        const btn = document.getElementById(`${id}-btn`);
        if(btn) { btn.disabled = true; btn.textContent = 'MENCARI JEJAK INSTITUSI...'; btn.className = 'btn'; }
        assets[asset].dir = null;
    }
}

function makeSignal(asset, isBull, type, limitPrice) {
    const a = assets[asset], id = asset.toLowerCase();
    a.dir = isBull ? 'BUY LIMIT' : 'SELL LIMIT';
    
    // Titik Entry menggunakan Limit Price (ujung Order Block), BUKAN harga saat ini
    const entry = limitPrice || a.price; 
    const slP = risk[type].sl[asset], tpP = slP * 3;
    
    document.getElementById(`${id}-signal`).style.display = 'block';
    document.getElementById(`${id}-dir`).textContent = `${a.dir} (${type})`;
    document.getElementById(`${id}-dir`).style.color = isBull ? '#10b981' : '#ef4444';
    
    // Cetak Angka ke Layar
    document.getElementById(`${id}-entry`).textContent = entry.toFixed(a.dec);
    document.getElementById(`${id}-sl`).textContent = (isBull ? entry - slP : entry + slP).toFixed(a.dec);
    document.getElementById(`${id}-tp`).textContent = (isBull ? entry + tpP : entry - tpP).toFixed(a.dec);
    
    const btn = document.getElementById(`${id}-btn`);
    btn.disabled = false; btn.textContent = `SET ${a.dir}`;
    btn.className = `btn ${isBull ? 'btn-buy' : 'btn-sell'}`;
}

function alarm() {
    try {
        const c = new (window.AudioContext || window.webkitAudioContext)();
        const o = c.createOscillator(), g = c.createGain();
        o.connect(g); g.connect(c.destination);
        o.frequency.value = 950; g.gain.setValueAtTime(0.2, c.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + 0.8);
        o.start(); o.stop(c.currentTime + 0.8);
    } catch(e){}
}

function toast(title, msg) {
    const c = document.getElementById('toast'), t = document.createElement('div');
    t.className = 'toast-msg'; t.innerHTML = `<strong style="color:var(--green)">${title}</strong><br>${msg}`;
    c.appendChild(t); setTimeout(() => t.remove(), 6000);
}
